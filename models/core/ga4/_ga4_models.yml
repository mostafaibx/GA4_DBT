version: 2

models:
  - name: fact_pageview
    description: >
      GA4 page_view-level fact (1 row per page_view event). Includes conformed keys,
      page-centric metrics (view order, time on page, entrances/exits), and a
      conformed join to dim_page using a shared page_key macro.
    columns:
      - name: event_id
        description: "Stable event identifier from stg_ga4_events."
        tests: [not_null, unique]
      - name: date_key
        description: "FK to dim_date (DATE(event_timestamp_utc))."
        tests: [not_null]
      - name: user_key
        description: "FK to dim_user (derived from user_pseudo_id)."
        tests: [not_null]
      - name: session_key
        description: "FK to fact_sessions (or dim_session if present)."
      - name: page_key
        description: "FK to dim_page; built with page_key_expr(url,title)."
        tests:
          - not_null
          - relationships:
              to: ref('dim_page')
              field: page_key
      - name: device_key
        description: "FK to dim_device (optional convenience)."
      - name: geo_key
        description: "FK to dim_geo (optional convenience)."
      - name: traffic_key
        description: "FK to dim_traffic (optional convenience)."
      - name: view_number_in_session
        description: "Ordinal of the pageview within its session."
      - name: time_on_page_sec
        description: >
          Time until the next page_view in the same session. Null on exits.
          Note: differs from GA4 UI time-on-page rules for last page.
      - name: is_entrance
        description: "True when this is the first pageview in the session."
      - name: is_exit
        description: "True when no subsequent pageview exists in the session."
      - name: page_domain
        description: "From dim_page; normalized host/domain."
      - name: page_path
        description: "From dim_page; normalized path (no protocol/host)."
      - name: page_query_clean
        description: "From dim_page; cleaned query string (UTM/gclid/fbclid removed)."

  - name: fact_order
    description: >
      Transaction-level fact built from GA4 'purchase' events in ga4_obfuscated_sample_ecommerce.
      One row per transaction_id, deduped. Includes line-item rollups, refund handling, and
      conformed keys to join sessions, users, device/geo/traffic, and dates.
    columns:
      - name: order_key
        description: "Surrogate PK for the order (hash of transaction_id)."
        tests: [not_null, unique]

      - name: transaction_id
        description: "GA4 transaction id from purchase/refund events."
        tests: [not_null]

      - name: date_key
        description: "FK to dim_date (DATE(order_ts))."
        tests: [not_null]

      - name: user_key
        description: "FK to dim_user."
        tests: [not_null]

      - name: session_key
        description: "FK for joining to fact_sessions (session of the purchase)."

      - name: device_key
        description: "FK to dim_device based on the purchase event."

      - name: geo_key
        description: "FK to dim_geo based on the purchase event."

      - name: traffic_key
        description: "FK to dim_traffic (UTM/source at purchase event time)."

      - name: revenue
        description: "Gross revenue captured on the chosen purchase event row."

      - name: tax
        description: "Tax amount captured on the purchase event."

      - name: shipping
        description: "Shipping amount captured on the purchase event."

      - name: refund_value
        description: "Total refunds for the transaction (prefers event total; falls back to items)."

      - name: net_revenue
        description: "revenue - refund_value."

      - name: line_items
        description: "Count of line items (from stg_ga4_items) in the transaction."

      - name: distinct_items
        description: "Distinct product count in the transaction (by product_item_id)."

      - name: items_quantity
        description: "Sum of item quantities for the transaction."

      - name: items_revenue
        description: "Sum of item revenues across all lines; used for cross-check."

      - name: revenue_mismatch_flag
        description: "True if items_revenue and purchase revenue differ by > 0.01; used as a data quality flag."

      - name: has_refund_flag
        description: "True if any refund is present for this transaction."

      - name: order_coupon
        description: "Coupon code applied at purchase (if present)."

      - name: order_affiliation
        description: "Affiliation/store name (if present)."

      - name: shipping_tier
        description: "Shipping tier/method if captured."

  - name: fact_order_item
    description: >
      Line-item grain fact for GA4 purchase events. One row per (transaction_id, item_index).
      Includes conformed keys (user/session/date/device/geo/traffic), normalized product
      attributes via dim_items, and item-level refund handling. 
    columns:
      - name: order_item_key
        description: "Surrogate PK for the line item: hash(transaction_id, item_index)."
        tests: [not_null, unique]

      - name: order_key
        description: "Hash(transaction_id); used to join to fact_order quickly."
        tests:
          - relationships:
              to: ref('fact_order')
              field: order_key

      - name: transaction_id
        description: "GA4 transaction id."
        tests: [not_null]

      - name: date_key
        description: "FK to dim_date (DATE(order_ts))."
        tests: [not_null]

      - name: user_key
        description: "FK to dim_user."
        tests: [not_null]

      - name: session_key
        description: "FK to fact_sessions (session of the purchase)."

      - name: item_key
        description: "FK to dim_items."
        tests:
          - not_null
          - relationships:
              to: ref('dim_items')
              field: item_key

      - name: item_quantity
        description: "Purchased quantity for the line."

      - name: item_revenue
        description: "Net line revenue on the purchase event (post-discount)."

      - name: refunded_item_quantity
        description: "Quantity refunded for this line item (from refund events)."

      - name: refunded_item_revenue
        description: "Revenue reversed for this line item (from refund events)."

      - name: net_item_quantity
        description: "item_quantity - refunded_item_quantity (not below 0)."

      - name: net_item_revenue
        description: "item_revenue - refunded_item_revenue."

      - name: item_discount_value
        description: "item_price*item_quantity - item_revenue (>=0)."

      - name: purchase_unit_price
        description: "item_revenue / item_quantity on the purchase event."

      - name: effective_unit_price
        description: "net_item_revenue / net_item_quantity after refunds."
  - name: fact_event
    description: "GA4 event-level fact (1 row per event_id)."
    columns:
      - name: event_id
        tests: [not_null, unique]
      - name: date_key
        tests: [not_null]
      - name: user_key
        tests: [not_null]
      - name: session_key
        tests: []
      - name: device_key
        tests: []
      - name: geo_key
        tests: []
      - name: traffic_key
        tests: []
      - name: page_key
        tests: []


  - name: fact_sessions
    description: >
      GA4 session-level fact (1 row per user_pseudo_id + ga_session_id). Includes conformed FK keys, session metrics,
      engagement flag, and landing page attribution.
    columns:
      - name: session_key
        description: "Surrogate key: hash(user_pseudo_id || ga_session_id)."
        tests: [not_null, unique]
      - name: date_key
        description: "FK to dim_date (session start date)."
        tests: [not_null]
      - name: user_key
        description: "FK to dim_user."
        tests: [not_null]
      - name: device_key
        description: "FK to dim_device (from first event in session)."
      - name: geo_key
        description: "FK to dim_geo (from first event in session)."
      - name: traffic_key
        description: "FK to dim_traffic_source (from first event in session)."
      - name: landing_page_key
        description: "FK to dim_page for first page_view in session (nullable)."
      - name: user_pseudo_id
        description: "GA4 pseudonymous user id (natural key)."
        tests: [not_null]
      - name: ga_session_id
        description: "GA4 session id (natural key)."
        tests: [not_null]
      - name: session_start_ts
        description: "First event timestamp in the session."
        tests: [not_null]
      - name: session_end_ts
        description: "Last event timestamp in the session."
      - name: session_duration_sec
        description: "Duration of session in seconds."
      - name: session_start_date
        description: "DATE(session_start_ts); table partition key."
      - name: events
        description: "Count of events in session."
      - name: pageviews
        description: "Count of page_view events in session."
      - name: engagement_time_ms
        description: "Sum of engagement_time_msec param across session."
      - name: conversions
        description: "Count of conversion events in session."
      - name: transactions
        description: "Distinct purchases (by transaction_id) in session."
      - name: revenue
        description: "Sum of purchase revenue in session (purchase events only)."
      - name: engaged_session_flag
        description: "GA4 engagement logic: ≥10s OR ≥2 pageviews OR any conversion."
      - name: session_number
        description: "User's session ordinal if available (max within session)."


  - name: dim_device
    description: >
      Conformed device dimension keyed on (category, os(+version), browser(+version)).
      Values are normalized (lower/trimmed). Attributes use most-recent non-null selection.
      Includes family rollups and first/last seen metadata.
    columns:
      - name: device_key
        description: "Conformed PK matching make_device_key() used in facts."
        tests: [not_null, unique]

      - name: device_category
        description: "GA4 device category: desktop, mobile, tablet, etc."
        tests: [not_null]

      - name: os
        description: "Operating system (normalized, lowercased)."
        tests: [not_null]

      - name: os_version
        description: "OS version (normalized)."

      - name: browser
        description: "Web browser (normalized)."
        tests: [not_null]

      - name: browser_version
        description: "Browser version (normalized)."

      - name: brand
        description: "Most-recent non-null mobile brand observed for this fingerprint."

      - name: model
        description: "Most-recent non-null mobile model observed for this fingerprint."

      - name: marketing_name
        description: "Most-recent marketing name (if available)."

      - name: hardware_model
        description: "Most-recent hardware model string."

      - name: language
        description: "Most-recent device language observed."

      - name: limit_ad_tracking
        description: "Most-recent limit-ad-tracking flag for this fingerprint."

      - name: os_family
        description: "Coarse OS family (ios, android, windows, macos, linux, chromeos)."

      - name: browser_family
        description: "Coarse browser family (chrome, safari, edge, firefox, etc.)."

      - name: is_mobile
        description: "True if category in (mobile, tablet)."

      - name: is_tablet
        description: "True if category = tablet."

      - name: is_desktop
        description: "True if category = desktop."

      - name: first_seen_ts
        description: "Earliest event timestamp for this fingerprint."

      - name: last_seen_ts
        description: "Latest event timestamp for this fingerprint."

      - name: events_observed
        description: "Total events observed with this fingerprint."

      - name: users_observed
        description: "Distinct users observed with this fingerprint."

  - name: dim_items
    description: >
      Product/item dimension for GA4 ecommerce. One row per item_key (aligned with facts).
      Attributes are Type 1 “current” using most-recent non-null values. Includes category helpers
      and observed price profiling for QA and analytics (not an authoritative price list).
    columns:
      - name: item_key
        description: "Conformed PK; must match item_key used in fact_order_item."
        tests: [not_null, unique]

      - name: product_item_id
        description: "Natural product ID if provided by the site/app."

      - name: item_name
        description: "Most-recent non-null display name."
      - name: item_name_norm
        description: "Lower/trimmed name for grouping."

      - name: item_brand
        description: "Most-recent brand."
      - name: item_brand_norm
        description: "Lower/trimmed brand for grouping."

      - name: item_variant
        description: "Most-recent variant or option label."
      - name: item_variant_norm
        description: "Lower/trimmed variant for grouping."

      - name: item_category1
        description: "Top-level category (most-recent)."
      - name: item_category2
      - name: item_category3
      - name: item_category4
      - name: item_category5
      - name: category_path
        description: "Concatenated non-empty categories with ' > '."
      - name: category_leaf
        description: "Deepest non-empty category."

      - name: first_seen_ts
        description: "Earliest item row observed."
      - name: last_seen_ts
        description: "Latest item row observed."
      - name: observed_item_rows
        description: "Row count in stg_ga4_items contributing to this item."

      - name: min_observed_price
      - name: p50_observed_price
      - name: p90_observed_price
      - name: max_observed_price
      - name: avg_observed_price
        description: "Observed price stats (for QA; may mix currencies)."

      - name: is_active_recent
        description: "True if last_seen within items_active_days (default 180)."

  - name: dim_geo
    description: >
      Conformed geography dimension keyed on (country, region, city, language).
      Values are normalized for key stability; continent/sub_continent/metro are descriptive
      attributes chosen from the most-recent non-null observations. Includes first/last seen
      and activity rollups for QA.
    columns:
      - name: geo_key
        description: "Conformed PK matching make_geo_key(country, region, city, language)."
        tests: [not_null, unique]

      - name: country
        description: "Lowercased country name from GA4 (canonical key component)."
      - name: region
        description: "Lowercased region/state/province (canonical key component)."
      - name: city
        description: "Lowercased city (canonical key component)."
      - name: language
        description: "Lowercased geo_language (canonical key component)."

      - name: country_display
        description: "Initcapped display variant for BI."
      - name: region_display
      - name: city_display
      - name: language_display
        description: "Uppercased language display (e.g., 'EN-US')."

      - name: continent
        description: "Most-recent continent label observed (not part of key)."
      - name: sub_continent
        description: "Most-recent sub-continent label (not part of key)."
      - name: metro
        description: "Most-recent metro label (US-only; not part of key)."

      - name: geo_scope
        description: "Precision level: city/region/country/unknown."

      - name: is_eu_member
        description: "Boolean derived from a maintained list of EU countries."

      - name: first_seen_ts
        description: "Earliest event timestamp for this fingerprint."
      - name: last_seen_ts
        description: "Latest event timestamp for this fingerprint."
      - name: events_observed
        description: "Total events observed with this fingerprint."
      - name: users_observed
        description: "Distinct users observed with this fingerprint."

  - name: dim_traffic
    description: >
      Conformed traffic dimension keyed on (source, medium, campaign, content, term).
      Values are normalized (lower/trim). Includes a defensible derived channel grouping,
      GA4's own channel label (when present), and activity rollups for QA.
    columns:
      - name: traffic_key
        description: "Conformed PK matching make_traffic_key(source, medium, campaign, content, term)."
        tests: [not_null, unique]

      - name: source
        description: "Lowercased traffic source (UTM source or referrer domain label)."
        tests: [not_null]
      - name: medium
        description: "Lowercased traffic medium (e.g., cpc, organic, referral, email)."
        tests: [not_null]
      - name: campaign
        description: "Lowercased campaign identifier (may be empty)."
      - name: content
        description: "Lowercased ad/content identifier (may be empty)."
      - name: term
        description: "Lowercased keyword/term (may be empty)."

      - name: source_display
        description: "Pretty-cased source for BI."
      - name: medium_display
      - name: campaign_display
      - name: content_display
      - name: term_display

      - name: channel_grouping
        description: "Derived channel grouping from source/medium/term classification."
      - name: source_host
        description: "Host extracted from source if it looks like a URL/domain."
      - name: ga4_channel_grouping
        description: "GA4-provided session_default_channel_grouping if available."

      - name: is_paid
        description: "True for Paid Search/Paid Social/Display/Video."
      - name: is_nonpaid
        description: "True for Organic Search/Organic Social/Referral/Email/Direct."

      - name: first_seen_ts
        description: "Earliest event timestamp observed for this fingerprint."
      - name: last_seen_ts
        description: "Latest event timestamp observed for this fingerprint."
      - name: events_observed
        description: "Total events observed with this fingerprint."
      - name: sessions_observed
        description: "Distinct sessions observed with this fingerprint."
      - name: users_observed
        description: "Distinct users observed with this fingerprint."