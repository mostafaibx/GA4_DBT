version: 2

models:
  - name: stg_ga4_events
    description: "Cleaned GA4 events staging. Typed timestamps, key params extracted, raw arrays preserved."
    columns:
      - name: event_id
        description: "Deterministic surrogate key for the event."
        tests: [not_null, unique]
      - name: event_date_dt
        description: "Event date (UTC) derived from GA4 export date."
        tests: [not_null]
      - name: event_timestamp_utc
        description: "Client event timestamp (UTC)."
      - name: event_previous_timestamp_utc
        description: "Previous event timestamp within the same session/user when present."
      - name: event_server_timestamp_offset_us
        description: "Server offset in microseconds relative to client event timestamp."
      - name: event_server_timestamp_utc
        description: "Server-adjusted event timestamp (UTC)."
      - name: event_name
        description: "GA4 event name."
        tests: [not_null]
      - name: user_pseudo_id
        description: "GA4 stable device/user pseudonymous id."
        tests: [not_null]
      - name: user_id
        description: "Site/app-authenticated user id when provided by the source."
      - name: ga_session_id
        description: "Session id extracted from event_params."
      - name: ga_session_number
        description: "Nth session for the user, from event_params."
      - name: param_transaction_id
        description: "Transaction id from event_params when present."
      - name: param_currency
        description: "3-letter currency code from event_params."
      - name: device_category
        description: "Device category (mobile/desktop/tablet)."
      - name: device_operating_system
        description: "OS name."
      - name: geo_country
        description: "Country reported by GA4."
      - name: traffic_source_name
        description: "Campaign name (when present)."
      - name: traffic_source_medium
        description: "Marketing medium."
      - name: traffic_source_source
        description: "Traffic source."
      - name: ecommerce_purchase_revenue
        description: "Purchase revenue in property currency."
      - name: ecommerce_purchase_revenue_in_usd
        description: "Purchase revenue normalized to USD."
      - name: ecommerce_transaction_id
        description: "Ecommerce transaction id from GA4 ecommerce struct."
      - name: items
        description: "Repeated items array. Kept raw for downstream item facts."

  - name: stg_ga4_items
    description: "One row per (event_id, item_index) from the GA4 items array."
    columns:
      - name: event_id
        description: "FK to stg_ga4_events.event_id."
        tests:
          - not_null
          - relationships:
              to: ref('stg_ga4_events')
              field: event_id
      - name: event_item_key
        description: "Deterministic key: hash(event_id, item_index)."
        tests: [not_null, unique]
      - name: item_index
        description: "Item position within the event's items array."
        tests: [not_null]
      - name: product_item_id
        description: "Product's natural item_id from GA4 items struct."
      - name: item_price
        description: "Unit price."
      - name: item_quantity
        description: "Quantity purchased/affected."
      - name: item_revenue
        description: "Revenue attributed to this line item."
      - name: item_refund
        description: "Refund amount attributed to this line item."

  - name: stg_ga4_users
    description: "Latest snapshot per user_pseudo_id with first/last seen and latest device/geo."
    columns:
      - name: user_key
        description: "Surrogate key for the user."
        tests: [not_null, unique]
      - name: user_pseudo_id
        description: "GA4 stable device/user pseudonymous id."
        tests: [not_null]
      - name: first_seen_ts
        description: "User's first seen timestamp in UTC."
      - name: last_seen_ts
        description: "User's most recent event timestamp in UTC."
      - name: device_category_latest
        description: "Latest observed device category."
      - name: os_latest
        description: "Latest observed operating system."
      - name: country_latest
        description: "Latest observed country."
      - name: region_latest
        description: "Latest observed region."
      - name: city_latest
        description: "Latest observed city."
